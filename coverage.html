
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>handler: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/Yoochan45/go-game-rental-api/internal/handler/auth_handler.go (88.9%)</option>
				
				<option value="file1">github.com/Yoochan45/go-game-rental-api/internal/handler/booking_handler.go (0.0%)</option>
				
				<option value="file2">github.com/Yoochan45/go-game-rental-api/internal/handler/category_handler.go (0.0%)</option>
				
				<option value="file3">github.com/Yoochan45/go-game-rental-api/internal/handler/game_handler.go (0.0%)</option>
				
				<option value="file4">github.com/Yoochan45/go-game-rental-api/internal/handler/payment_handler.go (0.0%)</option>
				
				<option value="file5">github.com/Yoochan45/go-game-rental-api/internal/handler/review_handler.go (0.0%)</option>
				
				<option value="file6">github.com/Yoochan45/go-game-rental-api/internal/handler/user_handler.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package handler

import (
        "fmt"

        myResponse "github.com/Yoochan45/go-api-utils/pkg-echo/response"
        "github.com/Yoochan45/go-game-rental-api/internal/dto"
        "github.com/Yoochan45/go-game-rental-api/internal/repository/email"
        "github.com/Yoochan45/go-game-rental-api/internal/service"
        "github.com/Yoochan45/go-game-rental-api/internal/utils"
        "github.com/go-playground/validator/v10"
        "github.com/labstack/echo/v4"
        "github.com/sirupsen/logrus"
)

type AuthHandler struct {
        userService service.UserService
        jwtSecret   string
        validate    *validator.Validate
        emailRepo   email.EmailRepository
}

func NewAuthHandler(userService service.UserService, jwtSecret string, emailRepo email.EmailRepository) *AuthHandler <span class="cov8" title="1">{
        return &amp;AuthHandler{
                userService: userService,
                jwtSecret:   jwtSecret,
                validate:    utils.GetValidator(),
                emailRepo:   emailRepo,
        }
}</span>

// Register godoc
// @Summary Register user
// @Description Register a new user account
// @Tags Authentication
// @Accept json
// @Produce json
// @Param request body dto.RegisterRequest true "Registration details"
// @Success 201 {object} map[string]interface{} "User registered successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input or validation error"
// @Router /auth/register [post]
func (h *AuthHandler) Register(c echo.Context) error <span class="cov8" title="1">{
        var req dto.RegisterRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov8" title="1">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov8" title="1">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov8" title="1">user, err := h.userService.Register(&amp;req)
        if err != nil </span><span class="cov8" title="1">{
                logrus.WithError(err).Error("Registration failed")
                return myResponse.BadRequest(c, err.Error())
        }</span>

        // Send welcome email (no verification needed)
        <span class="cov8" title="1">go func() </span><span class="cov8" title="1">{
                subject := "Welcome to Game Rental Platform"
                htmlContent := fmt.Sprintf(`
                        &lt;h1&gt;Welcome %s!&lt;/h1&gt;
                        &lt;p&gt;Thank you for registering at Game Rental Platform.&lt;/p&gt;
                        &lt;p&gt;Your account is now active and ready to use.&lt;/p&gt;
                        &lt;p&gt;Start browsing our game collection and make your first rental!&lt;/p&gt;
                `, user.FullName)
                plainText := fmt.Sprintf("Welcome %s! Your account is now active.", user.FullName)

                if err := h.emailRepo.SendEmail(c.Request().Context(), user.Email, subject, plainText, htmlContent); err != nil </span><span class="cov0" title="0">{
                        logrus.WithError(err).Error("Failed to send welcome email")
                }</span>
        }()

        <span class="cov8" title="1">return myResponse.Created(c, "User registered successfully. You can now login.", map[string]interface{}{
                "user_id": user.ID,
                "email":   user.Email,
        })</span>
}

// Login godoc
// @Summary Login user
// @Description Authenticate user and return JWT token
// @Tags Authentication
// @Accept json
// @Produce json
// @Param request body dto.LoginRequest true "Login credentials"
// @Success 200 {object} dto.LoginResponse "Login successful"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Invalid credentials"
// @Router /auth/login [post]
func (h *AuthHandler) Login(c echo.Context) error <span class="cov8" title="1">{
        var req dto.LoginRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov8" title="1">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov8" title="1">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov8" title="1">response, err := h.userService.Login(&amp;req, h.jwtSecret)
        if err != nil </span><span class="cov8" title="1">{
                logrus.WithError(err).WithField("email", req.Email).Error("Login failed")
                return myResponse.Unauthorized(c, err.Error())
        }</span>

        <span class="cov8" title="1">return myResponse.Success(c, "Login successful", response)</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package handler

import (
        "time"

        echomw "github.com/Yoochan45/go-api-utils/pkg-echo/middleware"
        myRequest "github.com/Yoochan45/go-api-utils/pkg-echo/request"
        myResponse "github.com/Yoochan45/go-api-utils/pkg-echo/response"
        "github.com/Yoochan45/go-game-rental-api/internal/dto"
        "github.com/Yoochan45/go-game-rental-api/internal/model"
        "github.com/Yoochan45/go-game-rental-api/internal/service"
        "github.com/Yoochan45/go-game-rental-api/internal/utils"
        "github.com/go-playground/validator/v10"
        "github.com/labstack/echo/v4"
)

type BookingHandler struct {
        bookingService service.BookingService
        validate       *validator.Validate
}

func NewBookingHandler(bookingService service.BookingService) *BookingHandler <span class="cov0" title="0">{
        return &amp;BookingHandler{
                bookingService: bookingService,
                validate:       utils.GetValidator(),
        }
}</span>

// CreateBooking godoc
// @Summary Create booking
// @Description Create a new game rental booking
// @Tags Bookings
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param request body dto.CreateBookingRequest true "Booking details"
// @Success 201 {object} map[string]interface{} "Booking created successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Router /bookings [post]
func (h *BookingHandler) CreateBooking(c echo.Context) error <span class="cov0" title="0">{
        var req dto.CreateBookingRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        // Parse date strings
        <span class="cov0" title="0">startDate, err := time.Parse("2006-01-02", req.StartDate)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid start_date format (use YYYY-MM-DD)")
        }</span>
        <span class="cov0" title="0">endDate, err := time.Parse("2006-01-02", req.EndDate)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid end_date format (use YYYY-MM-DD)")
        }</span>

        <span class="cov0" title="0">userID := echomw.CurrentUserID(c)
        bookingData := &amp;model.Booking{
                UserID:    userID,
                GameID:    req.GameID,
                StartDate: startDate,
                EndDate:   endDate,
                Notes:     utils.PtrOrNil(req.Notes),
        }

        err = h.bookingService.Create(userID, bookingData)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Created(c, "Booking created successfully", bookingData)</span>
}

// GetMyBookings godoc
// @Summary Get my bookings
// @Description Get list of current user's bookings
// @Tags Bookings
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Bookings retrieved successfully"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Router /bookings/my [get]
func (h *BookingHandler) GetMyBookings(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c)
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.Unauthorized(c, "Unauthorized")
        }</span>

        <span class="cov0" title="0">params := utils.ParsePagination(c)

        bookings, total, err := h.bookingService.GetUserBookings(userID, params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Failed to retrieve bookings")
        }</span>

        <span class="cov0" title="0">meta := utils.CreateMeta(params, total)
        return myResponse.Paginated(c, "Bookings retrieved successfully", bookings, meta)</span>
}

// GetBookingDetail godoc
// @Summary Get booking detail
// @Description Get detailed information about a specific booking
// @Tags Bookings
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param booking_id path int true "Booking ID"
// @Success 200 {object} map[string]interface{} "Booking retrieved successfully"
// @Router /bookings/{booking_id} [get]
func (h *BookingHandler) GetBookingDetail(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c)
        bookingID := myRequest.PathParamUint(c, "booking_id")

        booking, err := h.bookingService.GetByID(userID, bookingID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.NotFound(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Booking retrieved successfully", booking)</span>
}

// CancelBooking godoc
// @Summary Cancel booking
// @Description Cancel a pending booking
// @Tags Bookings
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param booking_id path int true "Booking ID"
// @Success 200 {object} map[string]interface{} "Booking cancelled successfully"
// @Router /bookings/{booking_id}/cancel [patch]
func (h *BookingHandler) CancelBooking(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c)
        bookingID := myRequest.PathParamUint(c, "booking_id")

        err := h.bookingService.Cancel(userID, bookingID)
        if err != nil </span><span class="cov0" title="0">{
                return utils.MapServiceError(c, err)
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Booking cancelled successfully", nil)</span>
}

// Admin endpoints
// GetAllBookings godoc
// @Summary Get all bookings
// @Description Get list of all bookings (Admin only)
// @Tags Admin - Bookings
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Bookings retrieved successfully"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/bookings [get]
func (h *BookingHandler) GetAllBookings(c echo.Context) error <span class="cov0" title="0">{
        params := utils.ParsePagination(c)
        role := echomw.CurrentRole(c)

        bookings, total, err := h.bookingService.GetAll(model.UserRole(role), params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                return utils.MapServiceError(c, err)
        }</span>

        <span class="cov0" title="0">meta := utils.CreateMeta(params, total)
        return myResponse.Paginated(c, "Bookings retrieved successfully", bookings, meta)</span>
}

// UpdateBookingStatus godoc
// @Summary Update booking status
// @Description Update booking status (Admin only)
// @Tags Admin - Bookings
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "Booking ID"
// @Param request body object{status=string} true "New status"
// @Success 200 {object} map[string]interface{} "Booking status updated successfully"
// @Failure 400 {object} map[string]interface{} "Invalid booking ID"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/bookings/{id}/status [patch]
func (h *BookingHandler) UpdateBookingStatus(c echo.Context) error <span class="cov0" title="0">{
        bookingID := myRequest.PathParamUint(c, "id")
        if bookingID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid booking ID")
        }</span>

        <span class="cov0" title="0">var req struct {
                Status model.BookingStatus `json:"status" validate:"required"`
        }
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c)
        err := h.bookingService.UpdateStatus(model.UserRole(role), bookingID, req.Status)
        if err != nil </span><span class="cov0" title="0">{
                return utils.MapServiceError(c, err)
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Booking status updated successfully", nil)</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package handler

import (
        echomw "github.com/Yoochan45/go-api-utils/pkg-echo/middleware"
        myRequest "github.com/Yoochan45/go-api-utils/pkg-echo/request"
        myResponse "github.com/Yoochan45/go-api-utils/pkg-echo/response"
        "github.com/Yoochan45/go-game-rental-api/internal/dto"
        "github.com/Yoochan45/go-game-rental-api/internal/model"
        "github.com/Yoochan45/go-game-rental-api/internal/service"
        "github.com/Yoochan45/go-game-rental-api/internal/utils"
        "github.com/go-playground/validator/v10"
        "github.com/labstack/echo/v4"
)

type CategoryHandler struct {
        categoryService service.CategoryService
        validate        *validator.Validate
}

func NewCategoryHandler(categoryService service.CategoryService) *CategoryHandler <span class="cov0" title="0">{
        return &amp;CategoryHandler{
                categoryService: categoryService,
                validate:        utils.GetValidator(),
        }
}</span>

// GetAllCategories godoc
// @Summary Get active categories
// @Description Get list of active game categories
// @Tags Categories
// @Accept json
// @Produce json
// @Success 200 {object} map[string]interface{} "Categories retrieved successfully"
// @Router /categories [get]
func (h *CategoryHandler) GetAllCategories(c echo.Context) error <span class="cov0" title="0">{
        categories, err := h.categoryService.GetActiveCategories()
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Failed to retrieve categories")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Categories retrieved successfully", categories)</span>
}

// GetCategoryDetail godoc
// @Summary Get category detail
// @Description Get detailed information about a specific category
// @Tags Categories
// @Accept json
// @Produce json
// @Param id path int true "Category ID"
// @Success 200 {object} model.Category "Category retrieved successfully"
// @Failure 400 {object} map[string]interface{} "Invalid category ID"
// @Failure 404 {object} map[string]interface{} "Category not found"
// @Router /categories/{id} [get]
func (h *CategoryHandler) GetCategoryDetail(c echo.Context) error <span class="cov0" title="0">{
        categoryID := myRequest.PathParamUint(c, "id")
        if categoryID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid category ID")
        }</span>

        <span class="cov0" title="0">category, err := h.categoryService.GetCategoryByID(categoryID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.NotFound(c, "Category not found")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Category retrieved successfully", category)</span>
}

// CreateCategory godoc
// @Summary Create category
// @Description Create a new game category (Admin only)
// @Tags Admin - Categories
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param request body dto.CreateCategoryRequest true "Category details"
// @Success 201 {object} map[string]interface{} "Category created successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/categories [post]
func (h *CategoryHandler) CreateCategory(c echo.Context) error <span class="cov0" title="0">{
        var req dto.CreateCategoryRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c)

        // Create category data
        categoryData := &amp;model.Category{
                Name:        req.Name,
                Description: utils.PtrOrNil(req.Description),
                IsActive:    true,
        }

        err := h.categoryService.CreateCategory(model.UserRole(role), categoryData)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Created(c, "Category created successfully", categoryData)</span>
}

// UpdateCategory godoc
// @Summary Update category
// @Description Update category information (Admin only)
// @Tags Admin - Categories
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "Category ID"
// @Param request body dto.UpdateCategoryRequest true "Updated category details"
// @Success 200 {object} map[string]interface{} "Category updated successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/categories/{id} [put]
func (h *CategoryHandler) UpdateCategory(c echo.Context) error <span class="cov0" title="0">{
        categoryID := myRequest.PathParamUint(c, "id")
        if categoryID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid category ID")
        }</span>

        <span class="cov0" title="0">var req dto.UpdateCategoryRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c)

        // Create update data
        updateData := &amp;model.Category{
                Name:        req.Name,
                Description: utils.PtrOrNil(req.Description),
        }

        err := h.categoryService.UpdateCategory(model.UserRole(role), categoryID, updateData)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, err.Error())
        }</span>

        // Get updated category for response
        <span class="cov0" title="0">category, err := h.categoryService.GetCategoryByID(categoryID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Failed to retrieve updated category")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Category updated successfully", category)</span>
}

// DeleteCategory godoc
// @Summary Delete category
// @Description Delete a category (Admin only)
// @Tags Admin - Categories
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "Category ID"
// @Success 200 {object} map[string]interface{} "Category deleted successfully"
// @Failure 400 {object} map[string]interface{} "Invalid category ID"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/categories/{id} [delete]
func (h *CategoryHandler) DeleteCategory(c echo.Context) error <span class="cov0" title="0">{
        categoryID := myRequest.PathParamUint(c, "id")
        if categoryID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid category ID")
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c)
        err := h.categoryService.DeleteCategory(model.UserRole(role), categoryID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Category deleted successfully", nil)</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package handler

import (
        "log"

        echomw "github.com/Yoochan45/go-api-utils/pkg-echo/middleware"
        myRequest "github.com/Yoochan45/go-api-utils/pkg-echo/request"
        myResponse "github.com/Yoochan45/go-api-utils/pkg-echo/response"
        "github.com/Yoochan45/go-game-rental-api/internal/dto"
        "github.com/Yoochan45/go-game-rental-api/internal/model"
        "github.com/Yoochan45/go-game-rental-api/internal/service"
        "github.com/Yoochan45/go-game-rental-api/internal/utils"
        "github.com/go-playground/validator/v10"
        "github.com/labstack/echo/v4"
)

type GameHandler struct {
        gameService service.GameService
        validate    *validator.Validate
}

func NewGameHandler(gameService service.GameService) *GameHandler <span class="cov0" title="0">{
        return &amp;GameHandler{
                gameService: gameService,
                validate:    utils.GetValidator(),
        }
}</span>

// GetAllGames godoc
// @Summary Get all games
// @Description Get list of all active games
// @Tags Games
// @Accept json
// @Produce json
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Games retrieved successfully"
// @Router /games [get]
func (h *GameHandler) GetAllGames(c echo.Context) error <span class="cov0" title="0">{
        params := utils.ParsePagination(c)

        log.Printf("DEBUG GetAllGames: limit=%d, offset=%d", params.Limit, params.Offset)

        games, total, err := h.gameService.GetAll(params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("ERROR GetAllGames: %v", err)
                return myResponse.InternalServerError(c, "Failed to retrieve games")
        }</span>

        <span class="cov0" title="0">log.Printf("DEBUG GetAllGames: found %d games, total=%d", len(games), total)

        meta := utils.CreateMeta(params, total)
        return myResponse.Paginated(c, "Games retrieved successfully", games, meta)</span>
}

// GetGameDetail godoc
// @Summary Get game detail
// @Description Get detailed information about a specific game
// @Tags Games
// @Accept json
// @Produce json
// @Param id path int true "Game ID"
// @Success 200 {object} model.Game "Game retrieved successfully"
// @Failure 400 {object} map[string]interface{} "Invalid game ID"
// @Failure 404 {object} map[string]interface{} "Game not found"
// @Router /games/{id} [get]
func (h *GameHandler) GetGameDetail(c echo.Context) error <span class="cov0" title="0">{
        gameID := myRequest.PathParamUint(c, "id")
        if gameID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid game ID")
        }</span>

        <span class="cov0" title="0">game, err := h.gameService.GetByID(gameID) // Fix: GetByID bukan GetGameDetail
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.NotFound(c, "Game not found")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Game retrieved successfully", game)</span>
}

// SearchGames godoc
// @Summary Search games
// @Description Search games by name, description, or platform
// @Tags Games
// @Accept json
// @Produce json
// @Param q query string true "Search query"
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Games search results"
// @Failure 400 {object} map[string]interface{} "Search query required"
// @Router /games/search [get]
func (h *GameHandler) SearchGames(c echo.Context) error <span class="cov0" title="0">{
        query := myRequest.QueryString(c, "q", "")
        if query == "" </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Search query is required")
        }</span>

        <span class="cov0" title="0">params := utils.ParsePagination(c)

        games, err := h.gameService.Search(query, params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Failed to search games")
        }</span>

        <span class="cov0" title="0">meta := utils.CreateMeta(params, int64(len(games)))
        return myResponse.Paginated(c, "Games search results", games, meta)</span>
}

// CreateGame godoc
// @Summary Create new game
// @Description Create a new game listing (Admin only)
// @Tags Admin - Games
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param request body dto.CreateGameRequest true "Game details"
// @Success 201 {object} map[string]interface{} "Game created successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/games [post]
func (h *GameHandler) CreateGame(c echo.Context) error <span class="cov0" title="0">{
        var req dto.CreateGameRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">adminID := echomw.CurrentUserID(c)
        role := echomw.CurrentRole(c)

        gameData := &amp;model.Game{
                CategoryID:        req.CategoryID,
                Name:              req.Name,
                Description:       utils.PtrOrNil(req.Description),
                Platform:          utils.PtrOrNil(req.Platform),
                Stock:             req.Stock,
                RentalPricePerDay: req.RentalPricePerDay,
                SecurityDeposit:   req.SecurityDeposit,
                Condition:         model.GameCondition(req.Condition),
        }

        err := h.gameService.Create(adminID, model.UserRole(role), gameData)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Created(c, "Game created successfully", gameData)</span>
}

// UpdateGame godoc
// @Summary Update game
// @Description Update game information (Admin only)
// @Tags Admin - Games
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "Game ID"
// @Param request body dto.UpdateGameRequest true "Updated game details"
// @Success 200 {object} map[string]interface{} "Game updated successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/games/{id} [put]
func (h *GameHandler) UpdateGame(c echo.Context) error <span class="cov0" title="0">{
        gameID := myRequest.PathParamUint(c, "id")
        if gameID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid game ID")
        }</span>

        <span class="cov0" title="0">var req dto.UpdateGameRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">game, err := h.gameService.GetByID(gameID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.NotFound(c, "Game not found")
        }</span>

        // Update only if provided
        <span class="cov0" title="0">if req.CategoryID &gt; 0 </span><span class="cov0" title="0">{
                game.CategoryID = req.CategoryID
        }</span>
        <span class="cov0" title="0">if req.Name != "" </span><span class="cov0" title="0">{
                game.Name = req.Name
        }</span>
        <span class="cov0" title="0">if req.Description != "" </span><span class="cov0" title="0">{
                game.Description = &amp;req.Description
        }</span>
        <span class="cov0" title="0">if req.Platform != "" </span><span class="cov0" title="0">{
                game.Platform = &amp;req.Platform
        }</span>
        <span class="cov0" title="0">if req.Stock &gt; 0 </span><span class="cov0" title="0">{
                diff := req.Stock - game.Stock
                game.Stock = req.Stock
                game.AvailableStock += diff
        }</span>
        <span class="cov0" title="0">if req.RentalPricePerDay &gt; 0 </span><span class="cov0" title="0">{
                game.RentalPricePerDay = req.RentalPricePerDay
        }</span>
        <span class="cov0" title="0">if req.SecurityDeposit &gt; 0 </span><span class="cov0" title="0">{
                game.SecurityDeposit = req.SecurityDeposit
        }</span>
        <span class="cov0" title="0">if req.Condition != "" </span><span class="cov0" title="0">{
                game.Condition = model.GameCondition(req.Condition)
        }</span>

        <span class="cov0" title="0">adminID := echomw.CurrentUserID(c)
        role := echomw.CurrentRole(c)

        err = h.gameService.Update(adminID, model.UserRole(role), gameID, game)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Game updated successfully", game)</span>
}

// DeleteGame godoc
// @Summary Delete game
// @Description Delete a game (Admin only)
// @Tags Admin - Games
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "Game ID"
// @Success 200 {object} map[string]interface{} "Game deleted successfully"
// @Failure 400 {object} map[string]interface{} "Invalid game ID"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/games/{id} [delete]
func (h *GameHandler) DeleteGame(c echo.Context) error <span class="cov0" title="0">{
        gameID := myRequest.PathParamUint(c, "id")
        if gameID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid game ID")
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c)
        err := h.gameService.Delete(model.UserRole(role), gameID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Game deleted successfully", nil)</span>
}
</pre>
		
		<pre class="file" id="file4" style="display: none">package handler

import (
        echomw "github.com/Yoochan45/go-api-utils/pkg-echo/middleware"
        myRequest "github.com/Yoochan45/go-api-utils/pkg-echo/request"
        myResponse "github.com/Yoochan45/go-api-utils/pkg-echo/response"
        "github.com/Yoochan45/go-game-rental-api/internal/dto"
        "github.com/Yoochan45/go-game-rental-api/internal/model"
        "github.com/Yoochan45/go-game-rental-api/internal/service"
        "github.com/Yoochan45/go-game-rental-api/internal/utils"
        "github.com/go-playground/validator/v10"
        "github.com/labstack/echo/v4"
)

type PaymentHandler struct {
        paymentService service.PaymentService
        validate       *validator.Validate
}

func NewPaymentHandler(paymentService service.PaymentService) *PaymentHandler <span class="cov0" title="0">{
        return &amp;PaymentHandler{
                paymentService: paymentService,
                validate:       utils.GetValidator(),
        }
}</span>

// CreatePayment godoc
// @Summary Create payment
// @Description Create payment for a booking
// @Tags Payments
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param booking_id path int true "Booking ID"
// @Param request body dto.CreatePaymentRequest true "Payment details"
// @Success 201 {object} model.Payment "Payment created successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Router /bookings/{booking_id}/payments [post]
func (h *PaymentHandler) CreatePayment(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c)
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.Unauthorized(c, "Unauthorized")
        }</span>

        <span class="cov0" title="0">bookingID := myRequest.PathParamUint(c, "booking_id")
        if bookingID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid booking ID")
        }</span>

        <span class="cov0" title="0">var req dto.CreatePaymentRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">payment, err := h.paymentService.CreatePayment(userID, bookingID, req.Provider, req.PaymentType)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Created(c, "Payment created successfully", payment)</span>
}

// GetPaymentByBooking godoc
// @Summary Get payment by booking
// @Description Get payment information for a specific booking
// @Tags Payments
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param booking_id path int true "Booking ID"
// @Success 200 {object} model.Payment "Payment retrieved successfully"
// @Failure 400 {object} map[string]interface{} "Invalid booking ID"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 404 {object} map[string]interface{} "Payment not found"
// @Router /bookings/{booking_id}/payments [get]
func (h *PaymentHandler) GetPaymentByBooking(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c)
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.Unauthorized(c, "Unauthorized")
        }</span>

        <span class="cov0" title="0">bookingID := myRequest.PathParamUint(c, "booking_id")
        if bookingID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid booking ID")
        }</span>

        <span class="cov0" title="0">payment, err := h.paymentService.GetPaymentByBooking(userID, bookingID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Payment retrieved successfully", payment)</span>
}

// GetPaymentDetail godoc
// @Summary Get payment detail
// @Description Get detailed payment information (Admin only)
// @Tags Admin - Payments
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "Payment ID"
// @Success 200 {object} model.Payment "Payment retrieved successfully"
// @Failure 400 {object} map[string]interface{} "Invalid payment ID"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Failure 404 {object} map[string]interface{} "Payment not found"
// @Router /admin/payments/{id} [get]
func (h *PaymentHandler) GetPaymentDetail(c echo.Context) error <span class="cov0" title="0">{
        paymentID := myRequest.PathParamUint(c, "id")
        if paymentID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid payment ID")
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c)
        payment, err := h.paymentService.GetPaymentDetail(model.UserRole(role), paymentID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Payment retrieved successfully", payment)</span>
}

// PaymentWebhook godoc
// @Summary Payment webhook
// @Description Receive payment status updates from payment provider
// @Tags Webhooks
// @Accept json
// @Produce json
// @Param request body dto.PaymentWebhookRequest true "Webhook payload"
// @Success 200 {object} map[string]interface{} "Webhook processed successfully"
// @Failure 400 {object} map[string]interface{} "Invalid webhook payload"
// @Router /webhooks/payments [post]
func (h *PaymentHandler) PaymentWebhook(c echo.Context) error <span class="cov0" title="0">{
        var webhookData map[string]interface{}
        if err := c.Bind(&amp;webhookData); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid webhook payload: "+err.Error())
        }</span>

        // Pass raw data to service (ProcessWebhook expects interface{})
        <span class="cov0" title="0">err := h.paymentService.ProcessWebhook(webhookData)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Webhook processed successfully", nil)</span>
}

// Admin endpoints
// GetAllPayments godoc
// @Summary Get all payments
// @Description Get list of all payments (Admin only)
// @Tags Admin - Payments
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Payments retrieved successfully"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/payments [get]
func (h *PaymentHandler) GetAllPayments(c echo.Context) error <span class="cov0" title="0">{
        params := utils.ParsePagination(c)
        role := echomw.CurrentRole(c)

        payments, total, err := h.paymentService.GetAllPayments(model.UserRole(role), params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                return utils.MapServiceError(c, err)
        }</span>

        <span class="cov0" title="0">meta := utils.CreateMeta(params, total)
        return myResponse.Paginated(c, "Payments retrieved successfully", payments, meta)</span>
}

// GetPaymentsByStatus godoc
// @Summary Get payments by status
// @Description Get list of payments filtered by status (Admin only)
// @Tags Admin - Payments
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param status query string true "Payment status" Enums(pending, completed, failed, refunded)
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Payments retrieved successfully"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/payments/status [get]
func (h *PaymentHandler) GetPaymentsByStatus(c echo.Context) error <span class="cov0" title="0">{
        params := utils.ParsePagination(c)
        status := c.QueryParam("status")
        role := echomw.CurrentRole(c)

        payments, total, err := h.paymentService.GetPaymentsByStatus(model.UserRole(role), model.PaymentStatus(status), params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                return utils.MapServiceError(c, err)
        }</span>

        <span class="cov0" title="0">meta := utils.CreateMeta(params, total)
        return myResponse.Paginated(c, "Payments retrieved successfully", payments, meta)</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package handler

import (
        echomw "github.com/Yoochan45/go-api-utils/pkg-echo/middleware"
        myRequest "github.com/Yoochan45/go-api-utils/pkg-echo/request"
        myResponse "github.com/Yoochan45/go-api-utils/pkg-echo/response"
        "github.com/Yoochan45/go-game-rental-api/internal/dto"
        "github.com/Yoochan45/go-game-rental-api/internal/model"
        "github.com/Yoochan45/go-game-rental-api/internal/service"
        "github.com/Yoochan45/go-game-rental-api/internal/utils"
        "github.com/go-playground/validator/v10"
        "github.com/labstack/echo/v4"
)

type ReviewHandler struct {
        reviewService service.ReviewService
        validate      *validator.Validate
}

func NewReviewHandler(reviewService service.ReviewService) *ReviewHandler <span class="cov0" title="0">{
        return &amp;ReviewHandler{
                reviewService: reviewService,
                validate:      utils.GetValidator(),
        }
}</span>

// CreateReview godoc
// @Summary Create review
// @Description Create a review for a completed booking
// @Tags Reviews
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param booking_id path int true "Booking ID"
// @Param request body dto.CreateReviewRequest true "Review details"
// @Success 201 {object} map[string]interface{} "Review created successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Router /bookings/{booking_id}/reviews [post]
func (h *ReviewHandler) CreateReview(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c)
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.Unauthorized(c, "Unauthorized")
        }</span>

        <span class="cov0" title="0">bookingID := myRequest.PathParamUint(c, "booking_id")
        if bookingID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid booking ID")
        }</span>

        <span class="cov0" title="0">var req dto.CreateReviewRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">reviewData := &amp;model.Review{
                Rating:  req.Rating,
                Comment: utils.PtrOrNil(req.Comment),
        }

        err := h.reviewService.CreateReview(userID, bookingID, reviewData)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Created(c, "Review created successfully", nil)</span>
}

// GetGameReviews godoc
// @Summary Get game reviews
// @Description Get list of reviews for a specific game
// @Tags Reviews
// @Accept json
// @Produce json
// @Param game_id path int true "Game ID"
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Reviews retrieved successfully"
// @Failure 400 {object} map[string]interface{} "Invalid game ID"
// @Failure 500 {object} map[string]interface{} "Internal server error"
// @Router /games/{game_id}/reviews [get]
func (h *ReviewHandler) GetGameReviews(c echo.Context) error <span class="cov0" title="0">{
        gameID := myRequest.PathParamUint(c, "game_id")
        if gameID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid game ID")
        }</span>

        <span class="cov0" title="0">params := utils.ParsePagination(c)

        reviews, err := h.reviewService.GetGameReviews(gameID, params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Failed to retrieve reviews")
        }</span>

        <span class="cov0" title="0">meta := utils.CreateMeta(params, int64(len(reviews)))
        return myResponse.Paginated(c, "Reviews retrieved successfully", reviews, meta)</span>
}
</pre>
		
		<pre class="file" id="file6" style="display: none">package handler

import (
        echomw "github.com/Yoochan45/go-api-utils/pkg-echo/middleware" // BALIK KE INI
        myRequest "github.com/Yoochan45/go-api-utils/pkg-echo/request"
        myResponse "github.com/Yoochan45/go-api-utils/pkg-echo/response"
        "github.com/Yoochan45/go-game-rental-api/internal/dto"
        "github.com/Yoochan45/go-game-rental-api/internal/model"
        "github.com/Yoochan45/go-game-rental-api/internal/service"
        "github.com/Yoochan45/go-game-rental-api/internal/utils"
        "github.com/go-playground/validator/v10"
        "github.com/labstack/echo/v4"
        "github.com/sirupsen/logrus"
)

type UserHandler struct {
        userService service.UserService
        validate    *validator.Validate
}

func NewUserHandler(userService service.UserService) *UserHandler <span class="cov0" title="0">{
        return &amp;UserHandler{
                userService: userService,
                validate:    utils.GetValidator(),
        }
}</span>

// GetMyProfile godoc
// @Summary Get current user profile
// @Description Get current user's profile information
// @Tags Users
// @Accept json
// @Produce json
// @Security BearerAuth
// @Success 200 {object} model.User "Profile retrieved successfully"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Router /users/me [get]
func (h *UserHandler) GetMyProfile(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c) // BALIK PAKAI INI

        user, err := h.userService.GetProfile(userID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.NotFound(c, "User not found")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Profile retrieved successfully", user)</span>
}

// UpdateMyProfile godoc
// @Summary Update current user profile
// @Description Update current user's profile information
// @Tags Users
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param request body dto.UpdateProfileRequest true "Profile update details"
// @Success 200 {object} model.User "Profile updated successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Router /users/me [put]
func (h *UserHandler) UpdateMyProfile(c echo.Context) error <span class="cov0" title="0">{
        userID := echomw.CurrentUserID(c) // BALIK PAKAI INI

        var req dto.UpdateProfileRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">err := h.userService.UpdateProfile(userID, &amp;req)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, err.Error())
        }</span>

        // Get updated profile
        <span class="cov0" title="0">user, err := h.userService.GetProfile(userID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Profile updated but failed to retrieve")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "Profile updated successfully", user)</span>
}

// GetAllUsers godoc
// @Summary Get all users
// @Description Get list of all users (Admin only)
// @Tags Admin - Users
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param page query int false "Page number" default(1)
// @Param limit query int false "Items per page" default(10)
// @Success 200 {object} map[string]interface{} "Users retrieved successfully"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/users [get]
func (h *UserHandler) GetAllUsers(c echo.Context) error <span class="cov0" title="0">{
        params := utils.ParsePagination(c)
        role := echomw.CurrentRole(c) // BALIK PAKAI INI

        users, totalCount, err := h.userService.GetAllUsers(model.UserRole(role), params.Limit, params.Offset)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">meta := utils.CreateMeta(params, totalCount)
        return myResponse.Paginated(c, "Users retrieved successfully", users, meta)</span>
}

// GetUserDetail godoc
// @Summary Get user detail
// @Description Get detailed information about a specific user (Admin only)
// @Tags Admin - Users
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "User ID"
// @Success 200 {object} model.User "User retrieved successfully"
// @Failure 400 {object} map[string]interface{} "Invalid user ID"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Failure 404 {object} map[string]interface{} "User not found"
// @Router /admin/users/{id} [get]
func (h *UserHandler) GetUserDetail(c echo.Context) error <span class="cov0" title="0">{
        userID := myRequest.PathParamUint(c, "id")
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid user ID")
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c) // BALIK PAKAI INI
        user, err := h.userService.GetUserDetail(model.UserRole(role), userID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "User retrieved successfully", user)</span>
}

// UpdateUserRole godoc
// @Summary Update user role
// @Description Update user role (Admin only)
// @Tags Admin - Users
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "User ID"
// @Param request body dto.UpdateUserRoleRequest true "Role update details"
// @Success 200 {object} map[string]interface{} "User role updated successfully"
// @Failure 400 {object} map[string]interface{} "Invalid input"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/users/{id}/role [patch]
func (h *UserHandler) UpdateUserRole(c echo.Context) error <span class="cov0" title="0">{
        userID := myRequest.PathParamUint(c, "id")
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid user ID")
        }</span>

        <span class="cov0" title="0">var req dto.UpdateUserRoleRequest
        if err := c.Bind(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid input: "+err.Error())
        }</span>
        <span class="cov0" title="0">if err := h.validate.Struct(&amp;req); err != nil </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Validation error: "+err.Error())
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c) // BALIK PAKAI INI
        err := h.userService.UpdateUserRole(model.UserRole(role), userID, req.Role)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        // Get updated user for response
        <span class="cov0" title="0">user, err := h.userService.GetUserDetail(model.UserRole(role), userID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Role updated but failed to retrieve user")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "User role updated successfully", user)</span>
}

// ToggleUserStatus godoc
// @Summary Toggle user status
// @Description Ban or unban a user (Admin only)
// @Tags Admin - Users
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "User ID"
// @Success 200 {object} map[string]interface{} "User status updated successfully"
// @Failure 400 {object} map[string]interface{} "Invalid user ID"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/users/{id}/status [patch]
func (h *UserHandler) ToggleUserStatus(c echo.Context) error <span class="cov0" title="0">{
        userID := myRequest.PathParamUint(c, "id")
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid user ID")
        }</span>

        <span class="cov0" title="0">role := echomw.CurrentRole(c) // BALIK PAKAI INI
        err := h.userService.ToggleUserStatus(model.UserRole(role), userID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.Forbidden(c, err.Error())
        }</span>

        // Get updated user for response
        <span class="cov0" title="0">user, err := h.userService.GetUserDetail(model.UserRole(role), userID)
        if err != nil </span><span class="cov0" title="0">{
                return myResponse.InternalServerError(c, "Status updated but failed to retrieve user")
        }</span>

        <span class="cov0" title="0">return myResponse.Success(c, "User status updated successfully", user)</span>
}

// DeleteUser godoc
// @Summary Delete user
// @Description Soft delete a user (Admin only)
// @Tags Admin - Users
// @Accept json
// @Produce json
// @Security BearerAuth
// @Param id path int true "User ID"
// @Success 200 {object} map[string]interface{} "User deleted successfully"
// @Failure 400 {object} map[string]interface{} "Invalid user ID"
// @Failure 401 {object} map[string]interface{} "Unauthorized"
// @Failure 403 {object} map[string]interface{} "Forbidden"
// @Router /admin/users/{id} [delete]
func (h *UserHandler) DeleteUser(c echo.Context) error <span class="cov0" title="0">{
        userID := myRequest.PathParamUint(c, "id")
        if userID == 0 </span><span class="cov0" title="0">{
                return myResponse.BadRequest(c, "Invalid user ID")
        }</span>

        // FIX: Pakai CurrentUserID() untuk dapat ID requester
        <span class="cov0" title="0">currentUserID := echomw.CurrentUserID(c) // TAMBAH INI
        role := echomw.CurrentRole(c)

        logrus.Info("=== DELETE USER ===")
        logrus.Info("Requester ID:", currentUserID)
        logrus.Info("Requester Role:", role)
        logrus.Info("Target User ID:", userID)

        // FIX: Pass currentUserID sebagai parameter pertama
        err := h.userService.DeleteUser(currentUserID, model.UserRole(role), userID)
        if err != nil </span><span class="cov0" title="0">{
                logrus.Error("Delete failed:", err)
                return myResponse.Forbidden(c, err.Error())
        }</span>

        <span class="cov0" title="0">logrus.Info("User deleted successfully")
        return myResponse.Success(c, "User deleted successfully", nil)</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
